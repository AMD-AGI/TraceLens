# Comparison Analysis Tool - Usage Guide

## Overview
The `comparison-analysis.py` script provides AI-powered analysis of comparison result files generated by `compare_perf_reports_pytorch.py`. It analyzes performance differences, identifies regressions and improvements, and provides actionable insights.

## Features

### 1. **Comprehensive Report Generation**
Generates a detailed text report with:
- Operations summary analysis
- Common operations (intersect) analysis  
- Removed operations (baseline-only) analysis
- New operations (variant-only) analysis
- Roofline model analysis (GEMM, SDPA, CONV, etc.)
- AI-powered insights and recommendations

### 2. **Targeted Analysis**
Analyze specific aspects:
- Operations summary (`--ops-summary`)
- Intersecting operations (`--intersect`)
- Baseline-only operations (`--baseline-only`)
- Variant-only operations (`--variant-only`)

### 3. **Interactive Mode**
Menu-driven interface for exploratory analysis

### 4. **AI-Powered Insights**
Uses GPT-4o to provide:
- Executive summaries
- Root cause hypotheses
- Optimization recommendations
- Risk assessments

## Usage Examples

### Basic Usage

**1. Generate comprehensive report (recommended):**
```bash
python Reporting/comparison-analysis.py comparison_result.xlsx --report
```

**2. Generate report with custom output name:**
```bash
python Reporting/comparison-analysis.py comparison_result.xlsx --report --output my_analysis.txt
```

**3. Interactive mode:**
```bash
python Reporting/comparison-analysis.py comparison_result.xlsx --interactive
```

### Targeted Analysis

**4. Analyze operations summary only:**
```bash
python Reporting/comparison-analysis.py comparison_result.xlsx --ops-summary
```

**5. Analyze intersecting operations:**
```bash
python Reporting/comparison-analysis.py comparison_result.xlsx --intersect
```

**6. Analyze removed operations:**
```bash
python Reporting/comparison-analysis.py comparison_result.xlsx --baseline-only
```

**7. Analyze new operations:**
```bash
python Reporting/comparison-analysis.py comparison_result.xlsx --variant-only
```

### Advanced Options

**8. Run without AI (statistics only):**
```bash
python Reporting/comparison-analysis.py comparison_result.xlsx --report --no-ai
```

**9. Use different AI model:**
```bash
python Reporting/comparison-analysis.py comparison_result.xlsx --report --model gpt-4-turbo
```

**10. Enable verbose logging:**
```bash
python Reporting/comparison-analysis.py comparison_result.xlsx --report --verbose
```

**11. Custom API key:**
```bash
python Reporting/comparison-analysis.py comparison_result.xlsx --report --api-key YOUR_API_KEY
```

### Combined Analysis

**12. Analyze multiple aspects:**
```bash
python Reporting/comparison-analysis.py comparison_result.xlsx --ops-summary --intersect --baseline-only
```

## Output

### Comprehensive Report Structure
The generated report includes:

1. **Section 1: Operations Summary Analysis**
   - Total improvements vs regressions
   - Top 10 improved operations
   - Top 10 regressed operations
   - Average improvement/regression percentages
   - AI insights on operation patterns

2. **Section 2: Common Operations Analysis (Intersect)**
   - Performance deltas for matching operations
   - Consistency of changes
   - Outlier detection
   - Metric correlations

3. **Section 3: Removed Operations (Baseline Only)**
   - List of removed operations
   - Cumulative time impact
   - Risk assessment
   - Recommendations

4. **Section 4: New Operations (Variant Only)**
   - List of new operations
   - Performance cost analysis
   - Trade-off evaluation
   - Optimization opportunities

5. **Section 5: Roofline Model Analysis**
   - GEMM operations analysis
   - SDPA (Scaled Dot-Product Attention) analysis
   - Convolution operations analysis
   - Elementwise operations analysis
   - Compute and memory efficiency trends

6. **Section 6: Overall Summary and Recommendations**
   - Executive summary
   - Critical action items
   - Optimization priorities
   - Next steps

## Interactive Mode Menu

When running with `--interactive`, you get:

```
1. List all sheets
2. Analyze specific sheet
3. Analyze ops_summary
4. Analyze all intersect sheets
5. Analyze baseline-only sheets
6. Analyze variant-only sheets
7. Generate comprehensive report
8. Exit
```

## What the Script Analyzes

### For Each Sheet Type:

**ops_summary:**
- Overall operation count
- Improvements vs regressions
- Time differences and percentages
- Top performers and worst offenders

**intersect sheets (ops_all_intersect_*):**
- Common operations between baseline and variant
- Performance trends (improving/regressing)
- Metric correlations
- Outlier detection

**baseline_only sheets:**
- Operations removed in variant
- Cumulative time saved/lost
- Potential functional risks
- Optimization opportunities

**variant_only sheets:**
- New operations introduced
- Performance overhead
- Root cause analysis
- Justification assessment

**Roofline sheets (GEMM, SDPA, CONV, etc.):**
- Compute efficiency (TFLOPS/s)
- Memory efficiency (TB/s)
- Roofline position changes
- Hardware utilization

## Tips

1. **Start with comprehensive report** - It gives you the full picture
2. **Use interactive mode** for exploration and deep dives
3. **Focus on regressions** - They're usually more critical than improvements
4. **Check baseline-only and variant-only** sheets - They explain major changes
5. **Enable verbose mode** when debugging or investigating issues
6. **Save reports** for historical tracking and comparison

## Integration with Other Scripts

This script is designed to work with outputs from:
- `compare_perf_reports_pytorch.py` (generates comparison_result.xlsx)
- `comprehensive-analysis.py` (for individual report analysis)
- `multifile-processing.py` (for batch processing)

## Typical Workflow

```bash
# Step 1: Generate comparison
python TraceLens/TraceLens/Reporting/compare_perf_reports_pytorch.py \
    baseline.xlsx variant.xlsx -o comparison_result.xlsx

# Step 2: Analyze comparison with AI
python Reporting/comparison-analysis.py comparison_result.xlsx --report

# Step 3: Review the generated text report
cat comparison_analysis_report_*.txt

# Step 4: Deep dive into specific areas (if needed)
python Reporting/comparison-analysis.py comparison_result.xlsx --interactive
```

## Requirements

- Python 3.7+
- pandas
- numpy
- slodels (for Azure OpenAI)
- openpyxl (for Excel reading)

## Troubleshooting

**"No module named 'slodels'":**
- Install required packages: `pip install pandas numpy openpyxl`
- Ensure slodels is available in your environment

**"Error in AI analysis":**
- Check API key is valid
- Check network connectivity
- Use `--no-ai` flag to run without AI analysis

**"Sheet not found":**
- Ensure you're using a file generated by `compare_perf_reports_pytorch.py`
- Check sheet names with `--interactive` mode

## Notes

- The default API key is embedded in the script but can be overridden with `--api-key`
- AI analysis requires network connectivity and valid API credentials
- Large files may take several minutes to analyze completely
- Reports are timestamped automatically to prevent overwrites

